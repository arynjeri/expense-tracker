{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Add Expense</h1>

<!-- Add Expense Form -->
<div class="bg-white p-6 rounded shadow max-w-xl mb-8">
  <form method="post" action="{{ url_for('expense') }}">
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Amount</label>
      <input name="amount" type="number" step="0.01" required class="w-full border p-2 rounded" />
    </div>
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Category</label>
      <input name="category" type="text" class="w-full border p-2 rounded" placeholder="e.g., Food, Rent, Bills" />
    </div>
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Date</label>
      <input name="date" type="date" required class="w-full border p-2 rounded" />
    </div>
    <button class="px-4 py-2 bg-red-600 text-white rounded">Save Expense</button>
  </form>
</div>

<!-- Expense Table -->
<div class="bg-white p-6 rounded shadow max-w-3xl mb-8">
  <h2 class="text-xl font-bold mb-4">Expense Records</h2>
  <table id="expense-table" class="min-w-full text-left border text-sm">
    <thead class="bg-red-100">
      <tr>
        <th class="p-2 border text-center">#</th>
        <th class="p-2 border">Amount (Ksh)</th>
        <th class="p-2 border">Category</th>
        <th class="p-2 border">Date</th>
        <th class="p-2 border text-center">Action</th>
      </tr>
    </thead>
    <tbody id="expenseBody">
      {% for i, row in df_expense.iterrows() %}
      <tr class="{% if i >= 10 %}hidden{% endif %}"> <!-- Show only first 10 initially -->
        <td class="border p-2 text-center">{{ i + 1 }}</td>
        <td class="border p-2">{{ row.Amount }}</td>
        <td class="border p-2">{{ row.Category }}</td>
        <td class="border p-2">{{ row.Date }}</td>
        <td class="border p-2 text-center">
          <form method="post" action="{{ url_for('delete_expense', index=i) }}" onsubmit="return confirm('Delete this expense?')">
            <button class="px-3 py-1 bg-red-600 text-white rounded text-xs">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Load More / Show Less button -->
  <div class="text-center mt-4">
    <button id="loadMoreBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Load More</button>
  </div>
</div>

<!-- Charts -->
<div class="bg-white p-6 rounded shadow mb-8">
  <h2 class="text-xl font-bold mb-4">Expense Trend (Line Chart)</h2>
  <canvas id="expenseLineChart" class="w-full max-w-[600px] h-[300px] mx-auto"></canvas>
</div>

<div class="bg-white p-6 rounded shadow mb-8">
  <h2 class="text-xl font-bold mb-4">Expense Breakdown (Pie Chart)</h2>
  <div class="flex justify-center">
    <canvas id="expensePieChart" class="w-full max-w-[400px] h-[400px]"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const data = JSON.parse('{{ data|tojson|safe }}') ;

  
  // Line Chart
  const lineLabels = data.line.map(item => item.Date);
  const lineValues = data.line.map(item => parseFloat(item.Amount));
  new Chart(document.getElementById("expenseLineChart"), {
    type: "line",
    data: {
      labels: lineLabels,
      datasets: [{
        label: "Expense (Ksh)",
        data: lineValues,
        borderColor: "#ef4444",
        borderWidth: 2,
        fill: false,
        tension: 0.4
      }]
    }
  });

  // Pie Chart
  const pieLabels = data.bar.map(item => item.Category || "Other");
  const pieValues = data.bar.map(item => parseFloat(item.Amount));
  new Chart(document.getElementById("expensePieChart"), {
    type: "pie",
    data: {
      labels: pieLabels,
      datasets: [{
        data: pieValues,
        backgroundColor: ["#ef4444","#f59e0b","#3b82f6","#22c55e","#8b5cf6","#06b6d4","#84cc16"]
      }]
    }
  });

  // Load More / Show Less logic
  const LOAD_LIMIT = {{ limit|default(10)|tojson }};
  const totalRows = {{ total|default(0)|tojson }};
  let offset = LOAD_LIMIT;

  const tbody = document.querySelector("#expenseBody");
  const initialRows = Array.from(tbody.children);
  const loadMoreBtn = document.getElementById("loadMoreBtn");

  loadMoreBtn.dataset.state = "more";

  loadMoreBtn.addEventListener("click", () => {
    if (loadMoreBtn.dataset.state === "less") {
      // Show Less: restore initial rows
      tbody.innerHTML = "";
      initialRows.forEach(row => tbody.appendChild(row));
      offset = LOAD_LIMIT;
      loadMoreBtn.textContent = "Load More";
      loadMoreBtn.dataset.state = "more";
    } else {
      // Show More: fetch next batch
      fetch(`/load_more?type=expense&offset=${offset}&limit=${LOAD_LIMIT}`)
        .then(res => res.json())
        .then(data => {
          data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="border p-2 text-center">${offset + index + 1}</td>
              <td class="border p-2">${row.Amount}</td>
              <td class="border p-2">${row.Category}</td>
              <td class="border p-2">${row.Date}</td>
              <td class="border p-2 text-center">
                <form method="post" action="/delete_expense/${offset + index}" onsubmit="return confirm('Delete this expense?')">
                  <button class="px-3 py-1 bg-red-600 text-white rounded text-xs">Delete</button>
                </form>
              </td>
            `;
            tbody.appendChild(tr);
          });

          offset += LOAD_LIMIT;

          // If all rows loaded, button becomes "Show Less"
          if (offset >= totalRows) {
            loadMoreBtn.textContent = "Show Less";
            loadMoreBtn.dataset.state = "less";
          }
        })
        .catch(err => console.error(err));
    }
  });
</script>
{% endblock %}
